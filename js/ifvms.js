"use strict";var Quetzal=IFF.subClass({init:function(s){if(this._super(s),s){if("IFZS"!=this.type)throw new Error("Not a Quetzal savefile");for(var t=0,e=this.chunks.length;t<e;t++){var i=this.chunks[t].type,r=this.chunks[t].data;"CMem"==i||"UMem"==i?(this.memory=r,this.compressed="CMem"==i):"Stks"==i?this.stacks=r:"IFhd"==i&&(this.release=r.slice(0,2),this.serial=r.slice(2,8),this.checksum=r.slice(8,10),this.pc=r[10]<<16|r[11]<<8|r[12])}}},write:function(){this.type="IFZS";var s=this.pc,t=new Array(13);return t[0]=this.release[0],t[1]=this.release[1],t[2]=this.serial[0],t[3]=this.serial[1],t[4]=this.serial[2],t[5]=this.serial[3],t[6]=this.serial[4],t[7]=this.serial[5],t[8]=this.checksum[0],t[9]=this.checksum[1],t[10]=s>>16&0xFF,t[11]=s>>8&0xFF,t[12]=0xFF&s,this.chunks=[{type:"IFhd",data:t},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this._super()}}),ZVMUI=function(s){var t=function(t,e){for(var i in e)e[i]!=s&&(t[i]=e[i]);return t},e=[0xFFFE,0xFFFF,0x0000,0x001D,0x0340,0x03BD,0x59A0,0x7C1F,0x77A0,0x7FFF,0x5AD6,0x4631,0x2D6B],i=function(s){var t=Math.round(8.226*(0x1F&s))<<16|Math.round(8.226*((0x03E0&s)>>5))<<8|Math.round(8.226*((0x7C00&s)>>10));for(t=t.toString(16);t.length<6;)t="0"+t;return"#"+t};return Object.subClass({colours:e,init:function(s,t){this._classname="ZVMUI",this.e=s,this.buffer="",this.styles={},this.mono=t,this.currentwin=0,this.status=[],s.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",css:t({},this.styles)})},convert_RGB:function(s){return Math.round(s[2]/8.226)<<10|Math.round(s[1]/8.226)<<5|Math.round(s[0]/8.226)},erase_line:function(s){1==s&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(s){this.flush(),s<1&&this.clear_window(),-1==s&&this.split_window(0),-2!=s&&1!=s||this.status.push({code:"clear"})},flush:function(){var s;""!=this.buffer&&(s={code:"stream",css:t({},this.styles),text:this.buffer},this.mono&&(s.node="tt",s.name="Fixed"),(this.currentwin?this.status:this.e.orders).push(s),this.buffer="")},get_cursor:function(s){this.status.push({code:"get_cursor",addr:s}),this.e.act()},set_colour:function(s,t){this.set_true_colour(e[s],e[t])},set_cursor:function(s,t){this.flush(),this.status.push({code:"cursor",to:[s-1,t-1]})},set_font:function(s){if(1!=s&&4!=s)return 0;var t=0x04&this.mono?4:1;return s!=t&&(this.flush(),this.mono^=0x04),t},set_style:function(t){var e=this.styles;this.flush(),0==t&&(e.reverse=e["font-weight"]=e["font-style"]=s,this.mono&=0xFE),0x01&t&&(e.reverse=1),0x02&t&&(e["font-weight"]="bold"),0x04&t&&(e["font-style"]="italic"),0x08&t&&(this.mono|=0x01)},set_true_colour:function(t,e){var r=this.styles,h=r.color,n=r["background-color"];this.flush(),0xFFFF==t?h=s:t<0x8000&&(h=i(t)),0xFFFF==e?n=s:e<0x8000&&(n=i(e)),r.color=h,r["background-color"]=n},set_window:function(s){this.flush(),this.currentwin=s,this.e.orders.push({code:"find",name:s?"status":"main"}),s&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(s){this.flush(),this.status.push({code:"height",lines:s})}})}();