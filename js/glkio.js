"use strict";var GlkIOClass=function(e,t){var n=GlkOte,i=null;function r(e){var l=t.e,s=!1,c=!1,d=null;"init"==e.type?(i=a(e.metrics),s=!0,c=!0):"arrange"==e.type?(i=a(e.metrics),s=!0,c=!1):"line"==e.type?(l.answer(0,"\n"),l.answer(1,e.value),d=e.value,c=!0):"specialsave"==e.type||"specialrestore"==e.type?(d=e.echoline,l.answer(0,e.success?1:0),c=!0):console.log("BUG: unhandled accept",e);var u=null;if(c&&(u=t.run()),null!=u&&u.length&&"save"==u[0].code){var p=u[0].data,g=n.getlibrary("Dialog"),f=e.gen;g.open(!0,"save",gamedat_ids.GAMEID,(e=>{var t=!1;e&&(t=Dialog.file_write(e,p,!1)),r({type:"specialsave",gen:f,success:t,echoline:d})}))}else if(null!=u&&u.length&&"restore"==u[0].code){g=n.getlibrary("Dialog"),f=e.gen;g.open(!1,"save",gamedat_ids.GAMEID,(e=>{var t=!1;if(e){var n=Dialog.file_read(e,!1);null!=n&&(l.loadSavedGame(n),t=!0)}r({type:"specialrestore",gen:f,success:t,echoline:d})}))}else{var h,m,w,y,v=e.gen+1,_={type:"update",gen:v};s&&(_.windows=(m=[],w=1,y=(h=i).outspacingy+(w*h.gridcharheight+h.gridmarginy)+h.inspacingy,m.push({id:1,type:"buffer",rock:11,left:h.outspacingx,top:y,width:h.width-2*h.outspacingx,height:h.height-(y+h.outspacingy)}),m.push({id:2,type:"grid",rock:22,left:h.outspacingx,top:h.outspacingy,width:h.width-2*h.outspacingx,height:w*h.gridcharheight+h.gridmarginy,gridwidth:Math.floor((h.width-h.gridmarginx)/h.gridcharwidth),gridheight:w}),m));var b=[],x=[],$=null,k=!1,I=!1;if(null!=d&&null!==u&&u.length){var D={append:!0,content:[{style:"input",text:d}]};x.push(D),x.push({})}if(null!==u)for(var C of u){if("stream"==C.code&&"status"!=C.to){var T="normal";C.css&&"italic"==C.css["font-style"]&&(T="emphasized"),C.css&&"bold"==C.css["font-weight"]&&(T="subheader"),"tt"==C.node&&(T="preformatted");var S=!0;for(var O of C.text.split("\n"))if(!S||O.length){D={};O.length&&(D.content=[{style:T,text:O}]),S&&(D.append=!0),x.push(D),S=!1}else S=!1}if("clear"==C.code&&(k=!0,x.length=0),"read"==C.code&&($={id:1,gen:v,type:"line",maxlen:C.maxlen}),"char"==C.code&&($={id:1,gen:v,type:"char"}),"quit"==C.code){I=!0;D={content:[{style:"emphasized",text:"The Z-machine has shut down. Reload this page to restart."}]};x.push({}),x.push(D),x.push({})}}if(s||c){var G=l.getStatusLine(o());b.push({line:0,content:[{style:"normal",text:G}]})}if(x.length||b.length){if(_.content=[],x.length){var M={id:1,text:x};k&&(M.clear=!0),_.content.push(M)}b.length&&_.content.push({id:2,lines:b})}I?_.input=[]:$&&(_.input=[$]),s=!1,n.update(_)}}function o(){if(i){var e=i;return Math.floor((e.width-e.gridmarginx)/e.gridcharwidth)}return 80}function a(e){var t,n={width:80,height:50,gridcharwidth:1,gridcharheight:1,buffercharwidth:1,buffercharheight:1,gridmarginx:0,gridmarginy:0,buffermarginx:0,buffermarginy:0,graphicsmarginx:0,graphicsmarginy:0,outspacingx:0,outspacingy:0,inspacingx:0,inspacingy:0};return void 0!==(t=e.charwidth)&&(n.gridcharwidth=t,n.buffercharwidth=t),void 0!==(t=e.charheight)&&(n.gridcharheight=t,n.buffercharheight=t),void 0!==(t=e.margin)&&(n.gridmarginx=t,n.gridmarginy=t,n.buffermarginx=t,n.buffermarginy=t,n.graphicsmarginx=t,n.graphicsmarginy=t),void 0!==(t=e.gridmargin)&&(n.gridmarginx=t,n.gridmarginy=t),void 0!==(t=e.buffermargin)&&(n.buffermarginx=t,n.buffermarginy=t),void 0!==(t=e.graphicsmargin)&&(n.graphicsmarginx=t,n.graphicsmarginy=t),void 0!==(t=e.marginx)&&(n.gridmarginx=t,n.buffermarginx=t,n.graphicsmarginx=t),void 0!==(t=e.marginy)&&(n.gridmarginy=t,n.buffermarginy=t,n.graphicsmarginy=t),void 0!==(t=e.spacing)&&(n.inspacingx=t,n.inspacingy=t,n.outspacingx=t,n.outspacingy=t),void 0!==(t=e.inspacing)&&(n.inspacingx=t,n.inspacingy=t),void 0!==(t=e.outspacing)&&(n.outspacingx=t,n.outspacingy=t),void 0!==(t=e.spacingx)&&(n.inspacingx=t,n.outspacingx=t),void 0!==(t=e.spacingy)&&(n.inspacingy=t,n.outspacingy=t),n=Object.assign(n,e)}return{_classname:"GlkIO",glkote:n,error:n.error,init:function(){var t={...e,accept:r};n.init(t)},get_status_width:o,create_save_file:function(e,t){n.getlibrary("Dialog");var i=Dialog.file_construct_ref(e,"save",gamedat_ids.GAMEID);Dialog.file_ref_exists(i)||Dialog.file_write(i,t,!1)}}},CommentaryClass=function(){let e=!1,t=!1;function n(){let n=$("#commentarypane");n.length&&e&&n.animate({opacity:0},{duration:200,start:function(){e=!1,t=!0},step:function(e,t){let i=Math.floor(400-400*e);n.css("transform","translateX("+i+"px)")},complete:function(){n.hide(),n.css("transform",""),t=!1}})}return $("#commentaryclose").on("click",(e=>{e.preventDefault(),e.stopPropagation(),n()})),{_classname:"Commentary",show:function(i,r){i?($("#commentarycontent").empty(),$("#commentarycontent").get(0).appendChild(i),$("#commentarytitle").text(function(e){if(!e)return"";var t=e.indexOf(":");if(t<0)return"";var n=e.slice(0,t);if("SRC"==n){var i=e.slice(t+1);return t=i.indexOf("-"),i.slice(0,t).toLowerCase()+".zil, line "+i.slice(t+1)}return e.slice(t+1)}(r)),function(){let n=$("#commentarypane");if(!n.length)return;if(e)return;n.animate({opacity:1},{duration:200,start:function(){e=!0,t=!0,n.show()},step:function(e,t){let i=Math.floor(400-400*e);n.css("transform","translateX("+i+"px)")},complete:function(){n.css("transform",""),t=!1}})}()):n()},hide:n}},GlkOteClass=function(){let e,t=!1,n=null,i="",r={},o="windowport",a="gameport",l="errorpane",s="errorcontent",c="loadingpane",d=800,u=0,p=-1,g=!1,f=null,h=!1,m=null,w=null,y=null,v=null,_=null,b=0,x=0,k=0;const I=[];let D=null,C=null,T=null,S=null,O=!1;let G=!1,M=null,j=null,B=null,E=null;const H=200,N=8,R=9,z=27,P=37,W=38,L=39,q=40,F=36,Q=35,U=33,A=34,X={escape:z,func1:112,func2:113,func3:114,func4:115,func5:116,func6:117,func7:118,func8:119,func9:120,func10:121,func11:122,func12:123},K={};let V=!1,Y=null,J=null,Z=null;const ee={},te={};function ne(e){t=!0,e.font_load_delay?(g=!0,ve((function(){g=!1,w=ie(),be("init",null,w)}))):be("init",null,w)}function ie(){const t={},r=$("#"+a,e);if(!r.length)return"Cannot find gameport element #"+a+" in this document.";$("#"+i+"layouttestpane",e).remove(),t.width=Math.max(0,r.width()-1),t.height=Math.max(0,r.height()-1);const o=$("<div>",{id:i+"layout_test_pane"});o.text("This should not be visible"),o.css({position:"absolute",visibility:"hidden",left:"-1000px"});const l=$("<div>");l.append($("<span>",{class:"Style_normal"}).text("12345678"));const s=$("<div>",{class:"WindowFrame GridWindow"}),c=l.clone().addClass("GridLine").appendTo(s),d=l.clone().addClass("GridLine").appendTo(s),u=c.children("span");o.append(s);const p=$("<div>",{class:"WindowFrame BufferWindow"}),g=l.clone().addClass("BufferLine").appendTo(p),f=l.clone().addClass("BufferLine").appendTo(p),h=$("<span>",{class:"InvisibleCursor"});f.append(h);const m=g.children("span");o.append(p);const w=$("<div>",{class:"WindowFrame GraphicsWindow"}),y=$("<canvas>");function v(e){return{width:e.outerWidth(),height:e.outerHeight()}}y.attr("width",64),y.attr("height",32),w.append(y),o.append(w),r.append(o);let _=v(s),b=v(u),x=v(c),k=v(d);t.gridcharheight=Math.max(1,d.position().top-c.position().top),t.gridcharwidth=Math.max(1,u.width()/8),t.gridmarginx=_.width-b.width,t.gridmarginy=_.height-(x.height+k.height),_=v(p),b=v(m),x=v(g),k=v(f),t.buffercharheight=Math.max(1,f.position().top-g.position().top),t.buffercharwidth=Math.max(1,m.width()/8),t.buffermarginx=_.width-b.width,t.buffermarginy=_.height-(x.height+k.height)+2,_=v(w);const I=v(y);return t.graphicsmarginx=_.width-I.width,t.graphicsmarginy=_.height-I.height,o.remove(),t.outspacingx=0,t.outspacingy=0,t.inspacingx=0,t.inspacingy=0,null!=n.spacing&&(t.outspacingx=n.spacing,t.outspacingy=n.spacing,t.inspacingx=n.spacing,t.inspacingy=n.spacing),null!=n.outspacing&&(t.outspacingx=n.outspacing,t.outspacingy=n.outspacing),null!=n.inspacing&&(t.inspacingx=n.inspacing,t.inspacingy=n.inspacing),null!=n.inspacingx&&(t.inspacingx=n.inspacingx),null!=n.inspacingy&&(t.inspacingy=n.inspacingy),null!=n.outspacingx&&(t.outspacingx=n.outspacingx),null!=n.outspacingy&&(t.outspacingy=n.outspacingy),t}function re(t){let n,r;if(!t)return;if(r=m.get(t.id),null==r){let a;r={id:t.id,type:t.type,rock:t.rock},m.set(t.id,r),"grid"==r.type&&(a="GridWindow"),"buffer"==r.type&&(a="BufferWindow"),"graphics"==r.type&&(a="GraphicsWindow");const l="WindowRock_"+t.rock;n=$("<div>",{id:i+"window"+t.id,class:"WindowFrame HasNoInputField "+a+" "+l}),n.data("winid",t.id),n.on("mousedown",t.id,Ge),"buffer"==r.type&&n.on("scroll",t.id,ze),"grid"!=r.type&&"graphics"!=r.type||n.on("click",r.id,Me),"buffer"==r.type&&n.attr({"aria-live":"polite","aria-atomic":"false","aria-relevant":"additions"}),r.frameel=n,r.gridheight=0,r.gridwidth=0,r.input=null,r.inputel=null,r.terminators={},r.reqhyperlink=!1,r.reqmouse=!1,r.needscroll=!1,r.needspaging=!1,r.scrolledtoend=!0,r.topunseen=0,r.pagefrommark=0,r.coords={left:null,top:null,right:null,bottom:null},r.history=new Array,r.historypos=0,$("#"+o,e).append(n)}else n=r.frameel,r.type!=t.type&&ue("Window "+t.id+" was created with type "+r.type+", but now is described as type "+t.type);if(r.inplace=!0,"grid"==r.type){if(t.gridheight>r.gridheight)for(let e=r.gridheight;e<t.gridheight;e++){const t=$("<div>",{id:i+"win"+r.id+"_ln"+e,class:"GridLine"});t.append("\xa0"),r.frameel.append(t)}if(t.gridheight<r.gridheight)for(let n=t.gridheight;n<r.gridheight;n++){const t=$("#"+i+"win"+r.id+"_ln"+n,e);t.length&&t.remove()}r.gridheight=t.gridheight,r.gridwidth=t.gridwidth}if(r.type,"graphics"==r.type){let n=$("#"+i+"win"+r.id+"_canvas",e);if(n.length){if(r.graphwidth!=t.graphwidth||r.graphheight!=t.graphheight){r.graphwidth=t.graphwidth,r.graphheight=t.graphheight,n.attr("width",r.graphwidth*r.scaleratio),n.attr("height",r.graphheight*r.scaleratio),n.css("width",r.graphwidth+"px"),n.css("height",r.graphheight+"px");const e=me(n);e&&(e.setTransform(r.scaleratio,0,0,r.scaleratio,0,0),e.fillStyle=r.defcolor,e.fillRect(0,0,r.graphwidth,r.graphheight),e.fillStyle="#000000"),r.frameel.css("background-color",r.defcolor);const i=r.id;ve((function(){Te(i)}))}}else{r.graphwidth=t.graphwidth,r.graphheight=t.graphheight,r.defcolor="#FFF",n=$("<canvas>",{id:i+"win"+r.id+"_canvas"}),r.backpixelratio=1;const e=me(n);e&&(r.backpixelratio=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1),r.scaleratio=y/r.backpixelratio,n.attr("width",r.graphwidth*r.scaleratio),n.attr("height",r.graphheight*r.scaleratio),n.css("width",r.graphwidth+"px"),n.css("height",r.graphheight+"px"),r.frameel.css("background-color",r.defcolor),e&&e.setTransform(r.scaleratio,0,0,r.scaleratio,0,0),r.frameel.append(n)}}const a=w.width-(t.left+t.width),l=w.height-(t.top+t.height),s={left:t.left+"px",top:t.top+"px"};r.coords.left=t.left,r.coords.top=t.top,r.coords.right=a,r.coords.bottom=l,n.css(s),n.outerWidth(t.width),n.outerHeight(t.height)}function oe(t){t.frameel.remove(),m.delete(t.id),t.frameel=null;const n=$("#"+i+"win"+t.id+"_moreprompt",e);n.length&&n.remove()}function ae(t){const n=m.get(t.id);if(null!=n)if(n.input&&"line"==n.input.type)ue("Got content update for window "+t.id+", which is awaiting line input.");else{if(n.needscroll=!0,"grid"==n.type){const r=t.lines;for(let o=0;o<r.length;o++){const a=r[o],l=a.line,s=a.content,c=$("#"+i+"win"+n.id+"_ln"+l,e);if(c.length)if(s&&s.length){c.empty();for(let e=0;e<s.length;e++){const t=s[e];let i,r,o;if("object"===jQuery.type(t)){if(void 0!==t.special)continue;i=t.style,r=t.text,o=t.hyperlink}else i=t,e++,r=s[e],o=void 0;const a=$("<span>",{class:"Style_"+i});if(null==o)he(a,r);else{const e=$("<a>",{href:"#",class:"Internal"});e.text(r),e.on("click",We(n.id,o)),a.append(e)}c.append(a)}}else c.text("\xa0");else ue("Got content for nonexistent line "+l+" of window "+t.id+".")}}if("buffer"==n.type){let r=t.text;n.inputel&&n.inputel.detach();let o=$("#"+i+"win"+n.id+"_cursor",e);o.length&&o.remove(),o=null,t.clear&&(n.frameel.empty(),n.topunseen=0,n.pagefrommark=0),void 0===r&&(r=[]);for(let e=0;e<r.length;e++){const t=r[e],i=t.content;let o=null;if(t.append){if(!i||!i.length)continue;o=le(n)}if(null==o&&(o=$("<div>",{class:"BufferLine BlankPara"}),o.data("blankpara",!0),n.frameel.append(o)),t.flowbreak&&o.addClass("FlowBreak"),i&&i.length){o.data("blankpara")&&(o.data("blankpara",!1),o.removeClass("BlankPara"),o.empty());for(let e=0;e<i.length;e++){const t=i[e];let r,a,l;if("object"===jQuery.type(t)){if(void 0!==t.special){if("image"==t.special){let e=t.url;if(E&&E.get_image_url){const n=E.get_image_url(t.image);n&&(e=n)}let i=$("<img>",{src:e,width:""+t.width,height:""+t.height});switch(t.alttext?i.attr("alt",t.alttext):i.attr("alt","Image "+t.image),t.alignment){case"inlineup":default:i.addClass("ImageInlineUp");break;case"inlinedown":i.addClass("ImageInlineDown");break;case"inlinecenter":i.addClass("ImageInlineCenter");break;case"marginleft":i.addClass("ImageMarginLeft");break;case"marginright":i.addClass("ImageMarginRight")}if(null!=t.hyperlink){const e=$("<a>",{href:"#",class:"Internal"});e.append(i),e.on("click",We(n.id,t.hyperlink)),i=e}o.append(i);continue}de("Unknown special entry in line data: "+t.special);continue}r=t.style,a=t.text,l=t.hyperlink}else r=t,e++,a=i[e],l=void 0;const s=$("<span>",{class:"Style_"+r});if(null==l)he(s,a);else{const e=$("<a>",{href:"#",class:"Internal"});e.text(a),e.on("click",We(n.id,l)),s.append(e)}o.append(s)}}else o.data("blankpara")&&o.append($("<span>",{class:"BlankLineSpan"}).text(" "))}const a=n.frameel.children();if(a.length){const e=a.length-d;if(e>0){const t=a.get(e).offsetTop;n.topunseen-=t,n.topunseen<0&&(n.topunseen=0),n.pagefrommark-=t,n.pagefrommark<0&&(n.pagefrommark=0);for(let t=0;t<e;t++)$(a.get(t)).remove()}}const l=le(n);if(l){const t=$("<span>",{id:i+"win"+n.id+"_cursor",class:"InvisibleCursor"}),r=$("<span>",{id:i+"win"+n.id+"_curspos",class:"InvisiblePos"});if(r.text("\u200d"),t.append(r),l.append(t),n.inputel){const r=n.inputel,o=$("#"+i+"win"+n.id+"_curspos",e).offset().left-n.frameel.offset().left,a=n.frameel.width()-(w.buffermarginx+o+2);a<H?r.css({width:H+"px",position:"",left:"",top:""}):r.css({width:a+"px",position:"absolute",left:"0px",top:"0px"}),t.append(r)}}}if("graphics"==n.type){let e=t.draw;void 0===e&&(e=[]);const i=0==I.length;for(let t=0;t<e.length;t++){const i=e[t],r={winid:n.id};Object.assign(r,i),I.push(r)}i&&I.length>0&&we(null)}}else ue("Got content update for window "+t.id+", which does not exist.")}function le(e){const t=function(e){const t=e.children();return t&&t.length?t.get(t.length-1):null}(e.frameel);return null==t||t.className.indexOf("BufferLine")<0?null:$(t)}function se(e){const t=le(e);return t&&t.length?t.get(0).offsetTop:0}function ce(e){k=0;let t=0;for(const e of m.values())e.needspaging&&(k+=1,t&&e.id!=x||(t=e.id));if(k&&(x=t),!k&&e){let e=0;if(!g&&!k)for(const t of m.values())t.input&&(e&&t.id!=b||(e=t.id));if(e){const t=m.get(e);t.inputel&&t.inputel.focus()}}}function de(e){window.console&&console.log?console.log(e):window.opera&&opera.postError&&opera.postError(e)}function ue(e){e||(e="???");let t=document.getElementById(s);t&&(fe(t),t.appendChild(document.createTextNode(e)),t=document.getElementById(l),"WarningPane"==t.className&&(t.className=null),t.style.display="",h=!0,ge())}function pe(){S=null,de("Retrying update..."),be("refresh",null,null)}function ge(){if(0==f)return;f=!1;const e=document.getElementById(c);e&&(e.style.display="none")}function fe(e){const t=e.childNodes;for(;t.length>0;){const n=t.item(0);e.removeChild(n)}}function he(e,t){if(G){if("match"==G){if(M.test(t)){const n=$("<a>",{href:t,class:"External",target:"_blank"});return n.text(t),void e.append(n)}}else if("search"==G){for(;;){const n=M.exec(t);if(!n)break;if(n.index>0){const i=t.substring(0,n.index);e.append(document.createTextNode(i))}const i=$("<a>",{href:n[0],class:"External",target:"_blank"});i.text(n[0]),e.append(i),t=t.substring(n.index+n[0].length)}if(!t.length)return}e.append(document.createTextNode(t))}else e.append(document.createTextNode(t))}function me(e){if(!e||!e.length)return;const t=e.get(0);return t&&t.getContext?t.getContext("2d"):void 0}function we(t,n){if(0!=I.length)for(;I.length;){const r=I[0],o=m.get(r.winid);if(!o){de("perform_graphics_ops: op for nonexistent window "+r.winid),I.shift();continue}const a=me($("#"+i+"win"+o.id+"_canvas",e));if(!a){de("perform_graphics_ops: op for nonexistent canvas "+o.id),I.shift();continue}const l=r.special;switch(l){case"setcolor":o.defcolor=r.color;break;case"fill":void 0===r.color?a.fillStyle=o.defcolor:a.fillStyle=r.color,void 0===r.x?(a.fillRect(0,0,o.graphwidth,o.graphheight),o.frameel.css("background-color",a.fillStyle)):a.fillRect(r.x,r.y,r.width,r.height),a.fillStyle="#000000";break;case"image":if(!t){const e=te[r.image];e&&e.width>0&&e.height>0?(t=e,n=!0):delete te[r.image]}if(!t){let e=r.url;if(E&&E.get_image_url){const t=E.get_image_url(r.image);t&&(e=t)}const t=new Image;return $(t).on("load",(function(e){we(t,e)})),$(t).on("error",(function(){we(t,null)})),void(t.src=e)}n&&(te[r.image]=t,a.drawImage(t,r.x,r.y,r.width,r.height)),n=null,t=null;break;default:de("Unknown special entry in graphics content: "+l)}I.shift()}else de("perform_graphics_ops called with no queued ops"+(t?" (plus image!)":""))}function ye(e,t){return window.setTimeout(t,1000*e)}function ve(e){return window.setTimeout(e,10)}function _e(e,t,n){let i=null;e.history.length&&(i=e.history[e.history.length-1]),t&&t!=i&&(e.history.push(t),e.history.length>20&&e.history.shift()),be("line",e,t,n)}function be(e,t,i,r){if(g&&"specialresponse"!=e)return;if(u<=p&&"init"!=e&&"refresh"!=e)return void de("Not sending repeated generation number: "+u);let o=0;t&&(o=t.id);const a={type:e,gen:u};if(p=u,"line"==e?(a.window=t.id,a.value=i,r&&(a.terminator=r)):"char"==e||"hyperlink"==e?(a.window=t.id,a.value=i):"mouse"==e?(a.window=t.id,a.x=i,a.y=r):"external"==e?a.value=i:"specialresponse"==e?(a.response=i,a.value=r):"debuginput"==e?a.value=i:"redraw"==e?a.window=t.id:"init"==e?(a.metrics=i,a.support=["timer","graphics","graphicswin","hyperlinks"]):"arrange"==e&&(a.metrics=i),"init"!=e&&"refresh"!=e&&"specialresponse"!=e&&"debuginput"!=e)for(const t of m.values()){if(("line"!=e&&"char"!=e||t.id!=o)&&t.input&&"line"==t.input.type&&t.inputel&&t.inputel.val()){let e=a.partial;e||(e={},a.partial=e),e[t.id]=t.inputel.val()}}V&&(Y.input=a,Y.timestamp=(new Date).getTime()),n.accept(a)}const xe={glkote_more:"More",glkote_taphere:"Tap here to type"};function $e(e){let t=r[e];return t||(t=xe[e],t||e)}function ke(e){jQuery.ajax(Z,{type:"POST",contentType:"application/json",data:JSON.stringify(e),error:function(e,t,n){de("Transcript recording failed; deactivating. Error "+t+": "+n),V=!1}})}function Ie(){null!=T&&(window.clearTimeout(T),T=null),T=ye(0.20,De)}function De(){if(T=null,g)return void(T=ye(0.20,De));const e=ie();var t,n;(n=w,(t=e).width!=n.width||t.height!=n.height||t.gridcharwidth!=n.gridcharwidth||t.gridcharheight!=n.gridcharheight||t.buffercharwidth!=n.buffercharwidth||t.buffercharheight!=n.buffercharheight)&&(w=e,be("arrange",null,w))}function Ce(){if(visualViewport.scale-1>0.001)return;if(v==visualViewport.height)return;v=visualViewport.height;const t=$("#"+a,e),n=t.outerHeight();let i=$(window).height()-v;i<_.top&&(i=_.top);const r=i-_.parenttop,o=$(window).height()-(i+_.bottom);n-o>=-1&&n-o<=1||(t.css("top",r+"px"),t.outerHeight(o),window.scrollTo(0,i),ve((function(){window.scrollTo(0,i)})))}function Te(e){const t=m.get(e);t&&"graphics"==t.type&&be("redraw",t,null)}function Se(){const t=window.devicePixelRatio||1;if(t!=y){y=t;for(const[t,n]of m.entries())if("graphics"==n.type){const r=$("#"+i+"win"+n.id+"_canvas",e);n.scaleratio=y/n.backpixelratio;const o=me(r);r.attr("width",n.graphwidth*n.scaleratio),r.attr("height",n.graphheight*n.scaleratio),r.css("width",n.graphwidth+"px"),r.css("height",n.graphheight+"px"),o&&(o.setTransform(n.scaleratio,0,0,n.scaleratio,0,0),o.fillStyle=n.defcolor,o.fillRect(0,0,n.graphwidth,n.graphheight),o.fillStyle="#000000"),n.frameel.css("background-color",n.defcolor),ve((function(){Te(t)}))}}}function Oe(t){if(g)return;let n=0;if(t&&(n=t.which),"INPUT"==t.target.tagName.toUpperCase())return;if(t.target.className.indexOf("CanHaveInputFocus")>=0)return;if(t.altKey||t.metaKey||t.ctrlKey)return;if(k){const n=m.get(x);if(n){t.preventDefault();const r=n.frameel;r.scrollTop(n.topunseen-w.buffercharheight);const o=r.outerHeight();n.scrolledtoend=r.scrollTop()+o+4>=r.get(0).scrollHeight;const a=se(n);let l=r.scrollTop()+o;if(l>a&&(l=a),n.topunseen<l&&(n.topunseen=l),n.needspaging&&n.scrolledtoend){n.needspaging=!1;const t=$("#"+i+"win"+n.id+"_moreprompt",e);t.length&&t.remove(),ce(!0)}return}}const r=m.get(b);if(r&&r.inputel){if(r.inputel.focus(),"line"!=r.input.type){let e=null;return 13==n?e="return":n==N?e="delete":n&&(e=String.fromCharCode(n)),e&&be("char",r,e),void t.preventDefault()}if(13==n)return _e(r,r.inputel.val(),null),void t.preventDefault();if(n){if(n>=32){const e=String.fromCharCode(n);r.inputel.val(r.inputel.val()+e)}t.preventDefault()}else;}}function Ge(e){const t=e.data,n=m.get(t);n&&(n.inputel&&(b=n.id),n.needspaging?x=n.id:n.inputel&&(x=0))}function Me(t){const n=t.data,r=m.get(n);if(!r)return;if(0!=t.button)return;if(!r.reqmouse)return;let o=0,a=0;if("grid"==r.type){const n=$("#"+i+"win"+r.id+"_ln0",e);if(n.length){const e=n.offset();o=Math.floor((t.clientX-e.left)/w.gridcharwidth),a=Math.floor((t.clientY-e.top)/w.gridcharheight)}o>=r.gridwidth&&(o=r.gridwidth-1),o<0&&(o=0),a>=r.gridheight&&(a=r.gridheight-1),a<0&&(a=0)}else{if("graphics"!=r.type)return;{const n=$("#"+i+"win"+r.id+"_canvas",e);if(n.length){const e=n.offset();o=t.clientX-e.left,a=t.clientY-e.top}o>=r.graphwidth&&(o=r.graphwidth-1),o<0&&(o=0),a>=r.graphheight&&(a=r.graphheight-1),a<0&&(a=0)}}t.preventDefault(),be("mouse",r,o,a)}function je(e){let t=0;if(e&&(t=e.keyCode),!t)return!0;let n=null;switch(t){case P:n="left";break;case L:n="right";break;case W:n="up";break;case q:n="down";break;case N:n="delete";break;case z:n="escape";break;case R:n="tab";break;case U:n="pageup";break;case A:n="pagedown";break;case F:n="home";break;case Q:n="end";break;case 112:n="func1";break;case 113:n="func2";break;case 114:n="func3";break;case 115:n="func4";break;case 116:n="func5";break;case 117:n="func6";break;case 118:n="func7";break;case 119:n="func8";break;case 120:n="func9";break;case 121:n="func10";break;case 122:n="func11";break;case 123:n="func12"}if(n){const e=$(this).data("winid"),t=m.get(e);return!t||!t.input||(be("char",t,n),!1)}return!0}function Be(e){let t,n=0;if(e&&(n=e.which),!n)return!1;t=13==n?"return":String.fromCharCode(n);const i=$(this).data("winid"),r=m.get(i);return!r||!r.input||(be("char",r,t),!1)}function Ee(e){const t=e.target.value[0];if(""===t||null==t)return!1;var n=$(this).data("winid"),i=m.get(n);return!i||!i.input||(e.target.value="",be("char",i,t)," "===t&&$(e.target).trigger("blur").trigger("focus"),!1)}function He(e){let t=0;if(e&&(t=e.keyCode),!t)return!0;if(t==W||t==q){const e=$(this).data("winid"),n=m.get(e);return!n||!n.input||(t==W&&n.historypos>0&&(n.historypos-=1,n.historypos<n.history.length?this.value=n.history[n.historypos]:this.value=""),t==q&&n.historypos<n.history.length&&(n.historypos+=1,n.historypos<n.history.length?this.value=n.history[n.historypos]:this.value=""),!1)}if(t==A||t==U||t==F||t==Q){const e=$(this).data("winid"),n=m.get(e);if(n){const e=n.frameel,i=e.outerHeight();let r=0;return r=t==A?e.scrollTop()+(i-w.buffercharheight):t==U?e.scrollTop()-(i-w.buffercharheight):t==F?0:e.get(0).scrollHeight,e.scrollTop(r),!1}}else if(K[t]){const e=$(this).data("winid"),n=m.get(e);if(!n||!n.input)return!0;if(n.terminators[K[t]])return _e(n,n.inputel.val(),K[t]),!1}return!0}function Ne(e){let t=0;if(e&&(t=e.which),!t)return!0;if(13==t){const e=$(this).data("winid"),t=m.get(e);return!t||!t.input||(_e(t,this.value,null),!1)}return!0}function Re(e){const t=e.data;m.get(t)&&(b=t,x=t)}function ze(t){const n=t.data,r=m.get(n);if(!r)return;const o=r.frameel,a=o.outerHeight();if(r.scrolledtoend=o.scrollTop()+a+4>=o.get(0).scrollHeight,!r.needspaging)return;const l=se(r);let s=o.scrollTop()+a;if(s>l&&(s=l),r.topunseen<s&&(r.topunseen=s),r.scrolledtoend){r.needspaging=!1;const t=$("#"+i+"win"+r.id+"_moreprompt",e);return t.length&&t.remove(),void ce(!0)}}function Pe(t){const n=t.frameel,r=n.outerHeight();n.scrollTop(n.get(0).scrollHeight-r),t.scrolledtoend=!0;const o=se(t);let a=n.scrollTop()+r;if(a>o&&(a=o),t.topunseen<a&&(t.topunseen=a),t.needspaging&&n.scrollTop()+r+4>=n.get(0).scrollHeight){t.needspaging=!1;const n=$("#"+i+"win"+t.id+"_moreprompt",e);n.length&&n.remove(),ce(!0)}}function We(e,t){return function(){const n=m.get(e);return!!n&&(!!n.reqhyperlink&&(be("hyperlink",n,t),!1))}}function Le(){D&&C&&(D=window.setTimeout(Le,C),g||be("timer"))}function qe(e){be("debuginput",null,e)}return{classname:"GlkOte",version:"2.3.6",init:function(t){if(!t&&window.Game&&(t=window.Game),!t)return void ue("No game interface object has been provided.");if(!t.accept)return void ue("The game interface object must have an accept() function.");if(n=t,!window.jQuery||!jQuery.fn.jquery)return void ue("The jQuery library has not been loaded.");const u=jQuery.fn.jquery.split(".");if(u.length<2||u[0]<1||1==u[0]&&u[1]<9)return void ue("This version of the jQuery library is too old. (Version "+jQuery.fn.jquery+" found; 1.9.0 required.)");for(const e in X)K[X[e]]=e;O="ontouchstart"in window,m=new Map,t.localize&&(r=t.localize),t.dom_prefix&&(i=t.dom_prefix),t.windowport&&(o=t.windowport),t.gameport&&(a=t.gameport),t.errorpane&&(l=t.errorpane),t.errorcontent&&(s=t.errorcontent),t.loadingpane&&(c=t.loadingpane);const p=$("#"+o,e);if(!p.length)return void ue("Cannot find windowport element #"+o+" in this document.");p.empty(),$(document).on("keypress",Oe),$(window).on("resize",Ie),y=window.devicePixelRatio||1;const g=$("#"+a,e),f=g.offsetParent();_={top:g.offset().top,bottom:$(window).height()-(g.offset().top+g.outerHeight()),parenttop:f.offset().top},window.matchMedia&&(window.matchMedia("screen and (min-resolution: 1.5dppx)").addListener(Se),window.matchMedia("screen and (min-resolution: 2dppx)").addListener(Se),window.matchMedia("screen and (min-resolution: 3dppx)").addListener(Se),window.matchMedia("screen and (min-resolution: 4dppx)").addListener(Se));const h=ie();if("string"!==jQuery.type(h)){if(w=h,function(){const t=$("#"+a,e);if(!t.length)return void console.log("Cannot find gameport element #"+a+" in this document.");function n(e){Ie()}try{new ResizeObserver(n).observe(t.get(0))}catch(e){console.log("ResizeObserver is not available in this browser.")}O&&window.visualViewport&&$(visualViewport).on("resize",Ce)}(),t.max_buffer_length&&(d=t.max_buffer_length),G=t.detect_external_links,G&&(M=t.regex_external_links,M||(M="search"==G?RegExp("\\b((?:https?://)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?\xab\xbb\u201c\u201d\u2018\u2019]))","i"):RegExp("^https?:","i"))),t.recording_url&&(V=!0,J=ke,Z=t.recording_url),t.recording_handler&&(V=!0,J=t.recording_handler,Z="(custom handler)"),V){const e=function(){var e={},t=location.search.substring(1,location.search.length);if(t.length){var n=t.split("&");t=t.replace(/\+/g," ");for(var i=0;i<n.length;i++){var r=n[i].split("="),o=decodeURIComponent(r[0]),a=2==r.length?decodeURIComponent(r[1]):o;e[o]=a}}return e}().feedback;if("undefined"!=jQuery.type(e)&&"1"!=e)V=!1,de("User has opted out of transcript recording.");else{let e=null;try{e=crypto.randomUUID()}catch(t){e=(new Date).getTime()+""+Math.ceil(10000*Math.random())}Y={sessionId:e,input:null,output:null,timestamp:0,outtimestamp:0},t.recording_label&&(Y.label=t.recording_label),"simple"==t.recording_format?Y.format="simple":Y.format="glkote",de("Transcript recording active: session "+Y.sessionId+' "'+Y.label+'", destination '+Z)}}if(t.debug_commands){let e=window.GiDebug;1!=t.debug_commands&&(e=t.debug_commands),e?(e.init(qe),j=e.output,t.debug_console_open&&e.open()):de("The debug_commands option is set, but there is no GiDebug module.")}if(t.Blorb&&(E=t.Blorb),t.Dialog?B=t.Dialog:window.DialogClass&&(B=new window.DialogClass),B&&!B.inited()){const e={GlkOte:this};if(t.dialog_dom_prefix&&(e.dom_prefix=t.dialog_dom_prefix),t.localize&&(e.localize=t.localize),B.init_async)return void B.init_async(e,(function(){ne(t)}));B.init&&B.init(e)}ne(t)}else ue(h)},inited:function(){return t},update:function(t){ge();let n=null;if(t.autorestore&&0==u&&(n=t.autorestore),V&&!n&&function(e){Y.output=e,Y.outtimestamp=(new Date).getTime();let t=!0;if("simple"==Y.format){const e=Y.input,n=Y.output;let i=null;if(e&&(i=e.type),"line"==i||"char"==i?Y.input=e.value:"init"!=i&&"external"!=i&&"specialresponse"!=i&&i?t=!1:Y.input="",n.windows){ee.bufferwins={};for(let e=0;e<n.windows.length;e++)"buffer"==n.windows[e].type&&(ee.bufferwins[n.windows[e].id]=!0)}let r="";if(n.content)for(let e=0;e<n.content.length;e++){const t=n.content[e];if(ee.bufferwins&&ee.bufferwins[t.id]&&t.text)for(let e=0;e<t.text.length;e++){const n=t.text[e];if(n.append||(r+="\n"),n.content)for(let e=0;e<n.content.length;e++){const t=n.content[e];"string"==jQuery.type(t)?(e++,r+=n.content[e]):t.text&&(r+=t.text)}}}Y.output=r}t&&J(Y);Y.input=null,Y.output=null,Y.timestamp=0,Y.outtimestamp=0}(t),t.debugoutput&&j&&j(t.debugoutput),"error"==t.type)return void ue(t.message);if("pass"==t.type)return;if("retry"==t.type)return void(S?de("Event has timed out, but a retry is already queued!"):(de("Event has timed out; will retry..."),function(){if(1==f)return;f=!0;const e=document.getElementById(c);e&&(e.style.display="")}(),S=ye(2,pe)));if("update"!=t.type)return void de("Ignoring unknown message type "+t.type+".");if(t.gen==u)return void de("Ignoring repeated generation number: "+u);if(t.gen<u)return void de("Ignoring out-of-order generation number: got "+t.gen+", currently at "+u);if(u=t.gen,g){for(const e of m.values())e.inputel&&e.inputel.prop("disabled",!1);g=!1}null!=t.input&&function(e){const t={};for(const n of e)n.type&&(t[n.id]=n);for(const e of m.values())if(e.input){const n=t[e.id];(null==n||n.gen>e.input.gen)&&(e.input=null,e.frameel.addClass("HasNoInputField"),e.frameel.removeClass("HasInputField"),e.inputel&&(e.inputel.remove(),e.inputel=null))}}(t.input),null!=t.windows&&function(e){for(const e of m.values())e.inplace=!1;e.forEach(re);const t=[];for(const e of m.values())e.inplace||t.push(e);for(const e of t)oe(e)}(t.windows),null!=t.content&&function(e){e.forEach(ae)}(t.content),null!=t.input&&function(t){const n={},r={},o={};for(const e of t)e.type&&(n[e.id]=e),e.hyperlink&&(r[e.id]=!0),e.mouse&&(o[e.id]=!0);for(const t of m.values()){t.reqhyperlink=r[t.id],t.reqmouse=o[t.id];const a=n[t.id];if(null==a)continue;t.input=a,t.frameel.addClass("HasInputField"),t.frameel.removeClass("HasNoInputField");let l=1;"line"==a.type&&(l=a.maxlen);let s=!1,c=t.inputel;if(null==c){s=!0;let e="Input";if("line"==a.type?e+=" LineInput":"char"==a.type?e+=" CharInput":ue("Window "+t.id+" has requested unrecognized input type "+a.type+"."),c=$("<input>",{id:i+"win"+t.id+"_input",class:e,type:"text",maxlength:l}),O&&(l<3?c.attr("placeholder","\u2316"):c.attr("placeholder",$e("glkote_taphere"))),c.attr({"aria-live":"off",autocapitalize:"off"}),"line"==a.type){if(c.on("keypress",Ne),c.on("keydown",He),a.initial&&c.val(a.initial),t.terminators={},a.terminators)for(let e=0;e<a.terminators.length;e++)t.terminators[a.terminators[e]]=!0}else"char"==a.type&&(c.on("keypress",Be),c.on("keydown",je),c.on("input",Ee));c.on("focus",t.id,Re),c.data("winid",t.id),t.inputel=c,t.historypos=t.history.length,t.needscroll=!0}if("grid"==t.type){const n=$("#"+i+"win"+t.id+"_ln"+a.ypos,e);if(!n.length)return void ue("Window "+t.id+" has requested input at unknown line "+a.ypos+".");const r=n.position(),o=r.left+Math.round(a.xpos*w.gridcharwidth);let d=Math.round(l*w.gridcharwidth);const u=t.frameel.width()-(w.buffermarginx+o+2);d>u&&(d=u),c.css({position:"absolute",left:o+"px",top:r.top+"px",width:d+"px"}),s&&t.frameel.append(c)}if("buffer"==t.type){let n=$("#"+i+"win"+t.id+"_cursor",e);if(!n.length){n=$("<span>",{id:i+"win"+t.id+"_cursor",class:"InvisibleCursor"});const e=$("<span>",{id:i+"win"+t.id+"_curspos",class:"InvisiblePos"});e.text("\u200d"),n.append(e),t.frameel.append(n)}const r=$("#"+i+"win"+t.id+"_curspos",e).offset().left-t.frameel.offset().left,o=t.frameel.width()-(w.buffermarginx+r+2);o<H?c.css({width:H+"px",position:"",left:"",top:""}):c.css({width:o+"px",position:"absolute",left:"0px",top:"0px"}),s&&n.append(c)}}}(t.input),void 0!==t.timer&&function(e){D&&(window.clearTimeout(D),D=null,C=null);e&&(C=e,D=window.setTimeout(Le,C))}(t.timer),null!=t.specialinput&&function(e){if("fileref_prompt"==e.type){let t=function(e){be("specialresponse",null,"fileref_prompt",e)};try{const n="read"!=e.filemode;B.open(n,e.filetype,e.gameid,t)}catch(e){GlkOte.log("Unable to open file dialog: "+e),t=function(){be("specialresponse",null,"fileref_prompt",null)},ve(t)}}else ue("Request for unknown special input type: "+e.type)}(t.specialinput);for(const t of m.values())if("buffer"==t.type&&t.needscroll){if(t.needscroll=!1,!t.needspaging){const n=t.frameel;{n.scrollTop(t.topunseen-w.buffercharheight);const e=n.outerHeight();t.scrolledtoend=n.scrollTop()+e+4>=n.get(0).scrollHeight,t.pagefrommark=t.topunseen;const i=se(t);let r=n.scrollTop()+e;r>i&&(r=i),t.topunseen<r&&(t.topunseen=r),n.scrollTop()+e+4>=n.get(0).scrollHeight||e<=w.buffercharheight?t.needspaging=!1:t.needspaging=!0}let r=$("#"+i+"win"+t.id+"_moreprompt",e),a=$("#"+i+"win"+t.id+"_prevmark",e);if(t.needspaging){if(!r.length){r=$("<div>",{id:i+"win"+t.id+"_moreprompt",class:"MorePrompt"}),r.text($e("glkote_more"));const n=t.coords.right+20,a=t.coords.bottom;r.css({bottom:a+"px",right:n+"px"}),$("#"+o,e).append(r)}a.length||(a=$("<div>",{id:i+"win"+t.id+"_prevmark",class:"PreviousMark"}),n.prepend(a)),a.css("top",t.pagefrommark+"px")}else r.length&&r.remove(),a.length&&a.remove()}}else if("buffer"==t.type&&t.scrolledtoend){const e=t.frameel;e.scrollTop(e.get(0).scrollHeight)}if(ce(!1),g=!1,t.disable||t.specialinput){g=!0;for(const e of m.values())e.inputel&&e.inputel.prop("disabled",!0)}let r=0;if(!g&&!k)for(const e of m.values())e.input&&(r&&e.id!=b||(r=e.id));if(r){const e=m.get(r);e.inputel&&e.inputel.focus()}if(n){if(n.history)for(const[e,t]of Object.entries(n.history)){const n=m.get(e);null!=n&&(n.history=t.slice(0),n.historypos=n.history.length)}if(n.defcolor)for(const[e,t]of Object.entries(n.defcolor)){const n=m.get(e);null!=n&&(n.defcolor=t)}n.recording_sessionid&&V&&Y&&(Y.sessionId=n.recording_sessionid,de("Transcript recording restored: session "+Y.sessionId+' "'+Y.label+'", destination '+Z));for(const e of m.values())"buffer"==e.type&&Pe(e);n.metrics&&n.metrics.width==w.width&&n.metrics.height==w.height||(w.width+=2,Ie())}},extevent:function(e){be("external",null,e)},getinterface:function(){return n},getlibrary:function(e){switch(e){case"Dialog":return B;case"Blorb":return E}return null},getdomid:function(e){switch(e){case"windowport":return o;case"gameport":return a;case"errorpane":return l;case"errorcontent":return s;case"loadingpane":return c}return e},getdomcontext:function(){return e},setdomcontext:function(t){e=t},save_allstate:function(){const e={metrics:{width:w.width,height:w.height},history:{}};for(const[t,n]of m.entries())n.history&&n.history.length&&(e.history[t]=n.history.slice(0)),n.defcolor&&(void 0===e.defcolor&&(e.defcolor={}),e.defcolor[t]=n.defcolor);return V&&Y&&(e.recording_sessionid=Y.sessionId),e},log:de,warning:function(e){if(h)return;if(!e)return void $("#"+l).hide();const t=document.getElementById(s);t&&(fe(t),t.appendChild(document.createTextNode(e)),$("#"+l).addClass("WarningPane"),$("#"+l).show(),ge())},error:ue}},GlkOte=new GlkOteClass;try{exports.GlkOte=GlkOte,exports.GlkOteClass=GlkOteClass}catch(e){}var DialogClass=function(){var e=null,t="dialog";let n={};var i,r,o,a,l,s,c,d,u,p=!1,g=null;function f(){var e=$("#"+t);e.length&&e.remove();var n=$("#"+t+"_frame");n.length&&n.remove();var i=$("#"+t+"_screen");i.length&&i.remove(),p=!1,g=null,u=null,o=!1,a=null}function h(e,n){var i=$("#"+(n?t+"_cap":t+"_cap2"));i.length&&(e?(i.text(e),i.show()):i.hide())}function m(e,t){return H(t?"dialog_usagepl_"+e:"dialog_usage_"+e)}function w(){if(!p)return!1;if(r)return!1;var e=$("#"+t+"_select");if(!e.length)return!1;var n=e.prop("selectedIndex");if(!u||n<0||n>=u.length)return!1;var i=u[n],o=$("#"+t+"_infield");return!!o.length&&(o.val(i.dirent.filename),!1)}function y(){if(!p)return!1;if(!o||a)return!1;var e=$("#"+t+"_delete");e.prop("disabled",!0),(e=$("#"+t+"_display")).prop("disabled",!0);var n=$("#"+t+"_select");if(!n.length)return!1;var i=n.prop("selectedIndex");if(!u||i<0||i>=u.length)return!1;var r=u[i];if(!r||!r.dirent||!O(r.dirent))return!1;(e=$("#"+t+"_delete")).prop("disabled",!1),(e=$("#"+t+"_display")).prop("disabled",!1)}function v(e){if(e.preventDefault(),!p)return!1;if(o)return!1;var n=$("#"+t+"_select");if(!n.length)return!1;var i=n.prop("selectedIndex");if(!u||i<0||i>=u.length)return!1;var r=u[i];if(!r||!r.dirent||!O(r.dirent))return!1;var a=g;return f(),a&&a(r.dirent),!1}function _(e){if(e.preventDefault(),!p)return!1;if(o)return!1;var n=$("#"+t+"_infield");if(!n.length)return!1;var i=n.val();if(!(i=jQuery.trim(i)).length)return!1;var a=C(i,l,d);if(O(a)&&!r){return r=!0,h(H("dialog_confirmreplace").replace("%1",s).replace("%2",a.filename),!1),n.prop("disabled",!0),$("#"+t+"_accept").text(H("dialog_replace")),!1}var c=g;return f(),c&&c(a),!1}function b(e){return e.preventDefault(),!!p&&(o?a?(o=!0,a=null,$("#"+t+"_buttonrow").show(),(i=$("#"+t+"_edit")).text(H("dialog_done")),D(),!1):(o=!1,a=null,(n=$("#"+t+"_input")).length&&n.show(),(i=$("#"+t+"_edit")).text(H("dialog_edit")),(i=$("#"+t+"_delete")).hide(),(i=$("#"+t+"_display")).hide(),(i=$("#"+t+"_accept")).show(),D(),!1):(o=!0,a=null,r&&(r=!1,h(null,!1),(n=$("#"+t+"_infield")).prop("disabled",!1),(i=$("#"+t+"_accept")).prop("disabled",!1),i.text(H("dialog_save"))),(n=$("#"+t+"_input")).length&&n.hide(),(i=$("#"+t+"_edit")).text(H("dialog_done")),(i=$("#"+t+"_delete")).show(),(i=$("#"+t+"_display")).show(),(i=$("#"+t+"_accept")).hide(),D(),!1));var n,i}function x(e){if(e.preventDefault(),!p)return!1;if(!o||a)return!1;var n=$("#"+t+"_select");if(!n.length)return!1;var i=n.prop("selectedIndex");if(!u||i<0||i>=u.length)return!1;var r=u[i];return!(!r||!r.dirent)&&(G(r.dirent),D(),!1)}function k(e){if(e.preventDefault(),!p)return!1;if(!o||a)return!1;var n=$("#"+t+"_select");if(!n.length)return!1;var i=n.prop("selectedIndex");if(!u||i<0||i>=u.length)return!1;var r=u[i];return!!(r&&r.dirent&&O(r.dirent))&&($("#"+t+"_buttonrow").hide(),$("#"+t+"_edit").text(H("dialog_close")),a=r.dirent,D(),!1)}function I(e){if(e.preventDefault(),!p)return!1;if(r){r=!1,h(null,!1),$("#"+t+"_infield").prop("disabled",!1);var n=$("#"+t+"_accept");return n.prop("disabled",!1),n.text(H("dialog_save")),!1}var i=g;return f(),i&&i(null),!1}function D(e){if(!p)return!1;var n,r,g,f,v;if(e&&e.key,!(r=$("#"+t+"_body")).length)return!1;if(o&&a&&(O(a)||(a=null,$("#"+t+"_buttonrow").show(),$("#"+t+"_edit").text(H("dialog_done")))),o&&a){r.empty();var _=M(a);if(_=String.fromCharCode.apply(this,_),"transcript"==(v=a.usage)||"command"==v){var b=$("<pre>",{class:"DiaDisplayText"});b.text(_),r.append(b),h(H("dialog_displayingcontents"),!0)}else{var x=window.btoa(_),k=$("<a>",{href:"data:application/octet-stream;base64,"+x,target:"_blank",download:"data"});k.text(a.filename),r.append(k),h(H("dialog_usesaveas"),!0)}return!1}if(o){if(g=B(null,d),""!=d&&(g=g.concat(B(null,""))),g.sort((function(e,t){return e.dirent.usage<t.dirent.usage?-1:e.dirent.usage>t.dirent.usage?1:t.modified.getTime()-e.modified.getTime()})),0==g.length)return r.empty(),$("#"+t+"_delete").prop("disabled",!0),$("#"+t+"_display").prop("disabled",!0),h(H("dialog_nostoredfiles"),!0),!1;for(u=[],f="",C=0;C<g.length;C++)(T=g[C]).dirent.usage!=f&&(f=T.dirent.usage,u.push({label:f})),u.push(T);g=u,r.empty(),(D=$("<select>",{id:t+"_select",name:"files"})).prop("size","5");var I=!1;for(C=0;C<g.length;C++)(T=g[C]).dirent?(n=$("<option>",{name:"f"+C}),I||(I=!0,n.selected=!0),S=N(T.modified),n.text(T.dirent.filename+" -- "+S),D.append(n)):((n=$("<option>",{name:"f"+C})).prop("disabled",!0),n.text("-- "+m(T.label,!0)+" --"),D.append(n));return r.append(D),D.on("change",y),y(),h(H("dialog_allvisible"),!0),!1}if((g=B(l,d)).sort((function(e,t){return t.modified.getTime()-e.modified.getTime()})),u=g,0==g.length)r.empty();else{var D,C,T,S;for(r.empty(),(D=$("<select>",{id:t+"_select",name:"files"})).prop("size","5"),C=0;C<g.length;C++)T=g[C],n=$("<option>",{name:"f"+C}),0==C&&(n.selected=!0),S=N(T.modified),n.text(T.dirent.filename+" -- "+S),D.append(n);r.append(D),i&&D.on("change",w)}if(i){h(H("dialog_namethis").replace("%1",s),!0),(n=$("#"+t+"_accept")).prop("disabled",!1)}else 0==g.length?(h(H("dialog_nousagefiles").replace("%1",c),!0),(n=$("#"+t+"_accept")).prop("disabled",!0)):(h(H("dialog_selectafile").replace("%1",s),!0),(n=$("#"+t+"_accept")).prop("disabled",!1))}function C(e,t,n){e||(e=""),t||(t=""),n||(n="");var i=t+":"+n+":"+e;return{dirent:"dirent:"+i,content:"content:"+i,filename:e,usage:t,gameid:n}}function T(e){if("dirent:"!=e.slice(0,7))return null;var t=7,n=e.indexOf(":",t);if(n<0)return null;var i=e.slice(t,n);if(t=n+1,(n=e.indexOf(":",t))<0)return null;var r=e.slice(t,n);t=n+1;var o=e.slice(t),a="cont"+e.slice(3);return{dirent:e,content:a,filename:o,usage:i,gameid:r}}function S(e){if("object"!=typeof e&&!(e=T(e)))return null;var t=R.getItem(e.dirent);if(!t)return null;var n,i,r,o,a={dirent:e},l=t.toString().split(",");for(n=0;n<l.length;n++)if(!((i=(o=l[n]).indexOf(":"))<0))switch(r=o.slice(0,i),o=o.slice(i+1),r){case"created":a.created=new Date(Number(o));break;case"modified":a.modified=new Date(Number(o))}return a}function O(e){return!!R.getItem(e.dirent)}function G(e){R.removeItem(e.dirent),R.removeItem(e.content)}function M(e,t){if(!S(e))return null;var n=R.getItem(e.content);return null==n?null:(n=n.toString())?t?n:JSON.parse(n):t?"":[]}function j(e,t,n){return(null==t||e.usage==t)&&(null==n||e.gameid==n)}function B(e,t){var n,i=[];if(!R)return i;var r=R.getKeys();for(n=0;n<r.length;n++){var o=r[n];if(o){var a=T(o.toString());if(a&&j(a,e,t)){var l=S(a);i.push(l)}}}return i}const E={dialog_cancel:"Cancel",dialog_close:"Close",dialog_done:"Done",dialog_edit:"Edit",dialog_delete:"Delete",dialog_display:"Display",dialog_load:"Load",dialog_replace:"Replace",dialog_save:"Save",dialog_namethis:"Name this %1.",dialog_confirmreplace:'You already have a %1 "%2". Do you want to replace it?',dialog_cookiewarning:"Warning: data may be erased by clearing cookies or browser privacy policies.",dialog_allvisible:"All stored files are now visible. You may delete them, and display files containing text. Press Done when finished.",dialog_displayingcontents:"Displaying file contents...",dialog_usesaveas:'Use "Save As" option in your browser to download this link.',dialog_nostoredfiles:"You have no stored files. Press Done to continue.",dialog_nousagefiles:"You have no %1 for this game.",dialog_selectafile:"Select a %1 to load.",dialog_usage_data:"data file",dialog_usage_save:"save file",dialog_usage_transcript:"transcript",dialog_usage_command:"command script",dialog_usage_default:"file",dialog_usagepl_data:"data files",dialog_usagepl_save:"save files",dialog_usagepl_transcript:"transcripts",dialog_usagepl_command:"command scripts",dialog_usagepl_default:"files"};function H(e){let t=n[e];return t||(t=E[e],t||e)}function N(e){return e?e.getMonth()+1+"/"+e.getDate()+" "+(e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()):"???"}var R=null;try{var z=null;if(null!=window.localStorage?z=window.localStorage:null!=window.globalStorage&&(z=window.globalStorage[location.hostname]),z)try{if(z.setItem("_dialogtest","xyzzy"),"xyzzy"!=z.getItem("_dialogtest"))throw new Error("localStorage test did not match");z.removeItem("_dialogtest"),R={getItem:function(e){try{return z.getItem(e)}catch(e){return null}},removeItem:function(e){try{z.removeItem(e)}catch(e){}},setItem:function(t,n){try{z.setItem(t,n)}catch(t){return e.log("Dialog: localStorage failed! "+t),!0}},getKeys:function(){for(var e=[],t=0;t<z.length;t++)e.push(z.key(t));return e}}}catch(t){e.log("Dialog: localStorage not available: "+t),e.log("Dialog: falling back to window memory")}}catch(e){}return null==R&&(R={data:{},keys:[],getItem:function(e){return R.data[e]},setItem:function(e,t){R.keys.indexOf(e)<0&&R.keys.push(e),R.data[e]=t},removeItem:function(e){var t=R.keys.indexOf(e);t>=0&&(R.keys.splice(t,1),delete R.data[e])},getKeys:function(){return R.keys.slice(0)}}),$(window).on("storage",D),{classname:"Dialog",version:"2.3.6",streaming:!1,init:function(i){if(i&&i.dom_prefix&&(t=i.dom_prefix),i&&i.localize&&(n=i.localize),i&&i.GlkOte&&(e=i.GlkOte),e||(e=window.GlkOte),!e)throw new Error("Dialog: no GlkOte interface!")},inited:function(){return null!=e},getlibrary:function(t){return"GlkOte"===t?e:null},open:function(n,u,f,h){if(p)throw new Error("Dialog: dialog box is already open.");if(!R)throw new Error("Dialog: no storage API is available.");g=h,i=n,r=!1,o=!1,a=null,d=f,s=m(l=u),c=m(l,!0);var w="windowport";window.GlkOte&&(w=e.getdomid("windowport"));var y=$("#"+w);if(!y.length)throw new Error("Dialog: unable to find root element #"+w+".");var C=$("#"+t+"_screen");C.length||(C=$("<div>",{id:t+"_screen",class:"DialogScreen"}),y.append(C));var T=$("#"+t+"_frame");T.length||(T=$("<div>",{id:t+"_frame",class:"DialogFrame"}),y.append(T));var S,O,G,M,j=$("#"+t);j.length&&j.remove(),j=$("<div>",{id:t,class:"Dialog"}),(S=$("<form>")).on("submit",i?_:v),j.append(S),G=$("<div>",{class:"DiaButtonsFloat"}),(O=$("<button>",{id:t+"_edit",type:"button"})).text(H("dialog_edit")),O.on("click",b),G.append(O),S.append(G),(G=$("<div>",{id:t+"_cap",class:"DiaCaption"})).text("XXX"),S.append(G),i&&(G=$("<div>",{id:t+"_input",class:"DiaInput"}),S.append(G),O=$("<input>",{id:t+"_infield",type:"text",name:"filename"}),G.append(O),(G=$("<div>",{id:t+"_warning",class:"DiaWarning"})).text(H("dialog_cookiewarning")),S.append(G)),G=$("<div>",{id:t+"_body",class:"DiaBody"}),S.append(G),(G=$("<div>",{id:t+"_cap2",class:"DiaCaption"})).hide(),S.append(G),G=$("<div>",{id:t+"_buttonrow",class:"DiaButtons"}),(O=$("<button>",{id:t+"_cancel",type:"button"})).text(H("dialog_cancel")),O.on("click",I),G.append(O),(O=$("<button>",{id:t+"_delete",type:"button"})).text(H("dialog_delete")),O.on("click",x),O.hide(),G.append(O),(O=$("<button>",{id:t+"_display",type:"button"})).text(H("dialog_display")),O.on("click",k),O.hide(),G.append(O),(O=$("<button>",{id:t+"_accept",type:"submit"})).text(H(i?"dialog_save":"dialog_load")),O.on("click",i?_:v),G.append(O),S.append(G),T.append(j),p=!0,D(),M=i?function(){var e=$("#"+t+"_infield");e.length&&e.focus()}:function(){var e=$("#"+t+"_select");e.length&&e.focus()},window.setTimeout(M,10)},file_clean_fixed_name:function(e,t){return e},file_construct_ref:C,file_construct_temp_ref:function(e){var t="_temp_"+(new Date).getTime()+"_"+Math.random();return C(t=t.replace(".",""),e)},file_ref_exists:O,file_remove_ref:G,file_write:function(e,t,n){var i,r,o,a,l=S(e);return l||(l={dirent:e,created:new Date}),l.modified=new Date,n||(t=JSON.stringify(t)),r=[],l.created&&r.push("created:"+l.created.getTime()),l.modified&&r.push("modified:"+l.modified.getTime()),i=r.join(","),o=R.setItem(l.dirent.dirent,i),a=R.setItem(l.dirent.content,t),!o&&!a},file_read:M,file_fopen:function(){throw new Error("streaming function not implemented in Dialog")},autosave_write:function(e,t){var n="autosave:"+e;t?R.setItem(n,JSON.stringify(t)):R.removeItem(n)},autosave_read:function(e){var t="autosave:"+e,n=R.getItem(t);if(n)try{return JSON.parse(n)}catch(e){}return null}}},Dialog=new DialogClass;try{exports.Dialog=Dialog,exports.DialogClass=DialogClass}catch(e){}